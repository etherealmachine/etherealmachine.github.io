<dom-module id="app-navbar">
	<script src="../bower_components/firebase/firebase.js"></script>
	<script src="form.js"></script>
	<style>
		.navbar-right {
    	margin-right: 0;
		}
		.alert {
			margin-bottom: 0;
		}
	</style>
	<template>
		<nav class="navbar navbar-default">
		  <div class="container-fluid">
		    <div class="navbar-header">
		    	<button
		    			type="button"
		    			class="navbar-toggle collapsed"
		    			data-toggle="collapse"
		    			data-target="#navbar-collapse">
		        <span class="sr-only">Toggle navigation</span>
		        <span class="icon-bar"></span>
		        <span class="icon-bar"></span>
		        <span class="icon-bar"></span>
		      </button>
		      <a class="navbar-brand" href$="{{ href('#') }}">
		      	etherealmachine.github.io
		      </a>
		    </div>
		    <div id="navbar-collapse" class="collapse navbar-collapse">
		    	<ul class="nav navbar-nav">
						<li class="active">
							<a href$="{{ href('#') }}">
								Home <span class="sr-only">(current)</span>
							</a>
						</li>
						<template
								is="dom-repeat"
								items="{{ categories }}">
						  <li>
						  	<a href$="{{ categoryLink(item) }}">
						  		<span>{{ title(item) }}</span>
						  	</a>
						  </li>
						</template>
					</ul>
		    	<span class$="{{ show(showLoginLink) }}">
				    <p
				    	class="navbar-text navbar-right">
					    <a
									href="#/login"
									role="button"
									on-click="showLogin">
								login
							</a>
				    </p>
				  </span>
				  <span class$="{{ show(showLogoutLink) }}">
				    <p
				    	class="navbar-text navbar-right">
					    <a
									href="#/logout"
									role="button"
									on-click="logout">
								logout
							</a>
						</p>
					</span>
			    <form class="navbar-form navbar-right">
						<div class$="{{ show(showLoginForm) }}">
							<div class="form-group">
								<input
										name="email"
										class="form-control"
										value="etherealmachine@gmail.com"
										type="hidden" />
								<input
										name="password"
										class="form-control"
										type="password" />
								<button
										type="submit"
										class="btn btn-primary"
										on-click="login">
									Login
								</button>
							</div>
						</div>
					</form>
				</div>
		  </div>
		  <div class$="{{ show(alert) }}">
		  	<div
		  			class="alert alert-danger"
		  			role="alert">
		  		<span>{{ alert }}</span>
		  	</div>
		  </div>
		</nav>
	</template>
	<script>
		var secureEndpoint = (
			window.location.href.startsWith('http://localhost') ||
			window.location.href.startsWith('https'));
		Polymer({
			is: 'app-navbar',
			ready: function() {
				var self = this;
				this.fb = new Firebase('https://etherealmachine.firebaseio.com');
				this.showLoginLink = secureEndpoint;
				this.showLogoutLink = false;
				this.showLoginForm = false;
				this.alert = null;
				this.fb.onAuth(function(user) {
					var authed = user != null && user.provider == 'password';
					if (authed) {
						self.set('showLoginLink', false);
						self.set('showLogoutLink', true);
					} else {
						self.set('showLoginLink', secureEndpoint);
						self.set('showLogoutLink', false);
					}
					self.set('showLoginForm', false);
					self.set('alert', null);
				});

				this.categories = [];
				this.fb = new Firebase(
					'https://etherealmachine.firebaseio.com/posts');
				this.fb.on('value', function(snapshot) {
					var categories = {};
					var val = snapshot.val();
					for (var id in val) {
						var post = val[id];
						if (post.category) {
							categories[post.category] = true;
						}
					}
					var categoryList = [];
					for (var category in categories) {
						categoryList.push(category);
					}
					self.set('categories', categoryList);
				});

			},
			show: function(v) {
				if (v) {
					return 'show';
				}
				return 'hide';
			},
			showLogin: function(e) {
				e.preventDefault();
				this.set('showLoginLink', false);
				this.set('showLoginForm', true);
			},
			login: function(e) {
				e.preventDefault();
				var self = this;
				var form = FormValues(e);
				this.fb.authWithPassword({
					email: form['email'],
					password: form['password']
				}, function(error, user) {
					if (error) {
				  	self.set('showLoginLink', secureEndpoint);
						self.set('showLoginForm', false);
						self.set('alert', error);
					}
				});
				this.querySelector('form').reset();
			},
			logout: function(e) {
				e.preventDefault();
				this.fb.unauth();
			},
			categoryLink: function(category) {
				return '#/category/' + category;
			},
			href: function(url) {
				return url;
			},
			title: function(category) {
				var words = category.split('-');
				for (var i = 0; i < words.length; i++) {
					if (nontitle[words[i]]) {
						continue;
					}
					words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1);
				}
				return words.join(' ');
			}
		});
		var nontitle = {
			'a': true,
			'an': true,
			'the': true,
			'and': true,
			'but': true,
			'for': true,
			'nor': true,
			'etc': true,
			'on': true,
			'at': true,
			'to': true,
			'from': true,
			'by': true
		};
	</script>
</dom-module>