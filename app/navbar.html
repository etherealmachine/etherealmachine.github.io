<dom-module id="app-navbar">
	<script src="../bower_components/firebase/firebase.js"></script>
	<script src="form.js"></script>
	<style>
		.navbar-right {
    	margin-right: 0;
		}
		.alert {
			margin-bottom: 0;
		}
	</style>
	<template>
		<nav class="navbar navbar-default">
		  <div class="container-fluid">
		    <div class="navbar-header">
		      <a class="navbar-brand" href="#">etherealmachine.github.io</a>
		    </div>
		    <div class="collapse navbar-collapse">
		    	<span class$="{{ show(showLoginLink) }}">
				    <p
				    	class="navbar-text navbar-right">
					    <a
									href="#"
									role="button"
									on-click="showLogin">
								login
							</a>
				    </p>
				  </span>
				  <span class$="{{ show(showLogoutLink) }}">
				    <p
				    	class="navbar-text navbar-right">
					    <a
									href="#"
									role="button"
									on-click="logout">
								logout
							</a>
						</p>
					</span>
			    <form class="navbar-form navbar-right">
						<div class$="{{ show(showLoginForm) }}">
							<div class="form-group">
								<input
										name="email"
										class="form-control"
										value="etherealmachine@gmail.com"
										type="hidden" />
								<input
										name="password"
										class="form-control"
										type="password" />
								<button
										type="submit"
										class="btn btn-primary"
										on-click="login">
									Login
								</button>
							</div>
						</div>
					</form>
				</div>
		  </div>
		  <div class$="{{ show(alert) }}">
		  	<div
		  			class="alert alert-danger"
		  			role="alert">
		  		<span>{{ alert }}</span>
		  	</div>
		  </div>
		</nav>
	</template>
	<script>
		Polymer({
			is: 'app-navbar',
			ready: function() {
				var self = this;
				this.fb = new Firebase('https://etherealmachine.firebaseio.com');
				var secureEndpoint = (
					window.location.href.startsWith('http://localhost') ||
					window.location.href.startsWith('https'));
				this.showLoginLink = secureEndpoint;
				this.showLogoutLink = false;
				this.showLoginForm = false;
				this.alert = null;
				this.fb.onAuth(function(user) {
					var authed = user != null && user.provider == 'password';
					if (authed) {
						self.set('showLoginLink', false);
						self.set('showLogoutLink', true);
					} else {
						self.set('showLoginLink', secureEndpoint);
						self.set('showLogoutLink', false);
					}
					self.set('showLoginForm', false);
					self.set('alert', null);
				});
			},
			show: function(v) {
				if (v) {
					return 'show';
				}
				return 'hide';
			},
			showLogin: function(e) {
				e.preventDefault();
				this.set('showLoginLink', false);
				this.set('showLoginForm', true);
			},
			login: function(e) {
				e.preventDefault();
				var self = this;
				var form = FormValues(e);
				this.fb.authWithPassword({
					email: form['email'],
					password: form['password']
				}, function(error, user) {
					if (error) {
				  	self.set('showLoginLink', secureEndpoint);
						self.set('showLoginForm', false);
						self.set('alert', error);
					}
				});
				this.querySelector('form').reset();
			},
			logout: function(e) {
				e.preventDefault();
				this.fb.unauth();
			}
		});
	</script>
</dom-module>