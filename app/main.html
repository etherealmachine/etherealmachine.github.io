<dom-module id="app-main">
	<script src="../bower_components/firebase/firebase.js"></script>
  <link rel="import" href="navbar.html">
  <link rel="import" href="post.html">
  <link rel="import" href="newpost.html">
	<template>
		<app-navbar></app-navbar>
		<div class="container">

			<template is="dom-if" if="{{ singlePost }}">
				<app-post postid="{{ postid }}"></app-post>
			</template>

			<template is="dom-if" if="{{ posts }}">
				<template
						id="posts"
						is="dom-repeat"
						items="{{ posts }}"
						filter="{{ filterPost(categoryFilter) }}">
					<app-post postid="{{ item.id }}"></app-post>
				</template>
			</template>

			<app-newpost class$="{{ show(authed) }}"></app-newpost>
	</template>
	<script>
		Polymer({
			is: 'app-main',
			ready: function() {
				var self = this;
				this.categoryFilter = '';
				this.posts = [];
				this.fb = new Firebase(
					'https://etherealmachine.firebaseio.com/posts');
				this.fb.on('value', function(snapshot) {
					var posts = [];
					var val = snapshot.val();
					for (var id in val) {
						var post = val[id];
						post.id = id;
						posts.push(post);
					}
					self.set('posts', posts);
				});
				this.authed = false;
				this.fb.onAuth(function(user) {
					self.set('authed', user != null && user.provider == 'password');
				});
				window.onhashchange = function() {
					self.hashChanged();
				};
				this.hashChanged();
			},
			hashChanged: function() {
				var path = location.hash.split('#/category/');
				if (path.length == 2) {
					this.set('categoryFilter', path[1]);
				} else {
					this.set('categoryFilter', '');
				}
			},
			filterPost: function(categoryFilter) {
				return function(post) {
					return !categoryFilter || post.category == categoryFilter;
				};
			},
			show: function(v) {
				if (v) {
					return 'show';
				}
				return 'hide';
			}
		});
	</script>
</dom-module>