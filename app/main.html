<dom-module id="app-main">
	<script src="../bower_components/firebase/firebase.js"></script>
  <link rel="import" href="navbar.html">
  <link rel="import" href="post.html">
  <link rel="import" href="newpost.html">
	<template>
		<app-navbar></app-navbar>
		<div class="container">

			<template
					id="posts"
					is="dom-repeat"
					items="{{ posts }}"
					filter="{{ filterPost(postFilter, categoryFilter) }}">
				<app-post postid="{{ item.id }}"></app-post>
			</template>

			<app-newpost class$="{{ show(authed) }}"></app-newpost>

	</template>
	<script>
		Polymer({
			is: 'app-main',
			ready: function() {
				var self = this;
				this.postFilter = '';
				this.categoryFilter = '';
				this.posts = [];
				this.fb = new Firebase(
					'https://etherealmachine.firebaseio.com/posts');
				this.fb.on('value', function(snapshot) {
					var posts = [];
					var val = snapshot.val();
					for (var id in val) {
						var post = val[id];
						post.id = id;
						posts.push(post);
					}
					self.set('posts', posts);
				});
				this.authed = false;
				this.fb.onAuth(function(user) {
					self.set('authed', user != null && user.provider == 'password');
				});
				window.onhashchange = function() {
					self.hashChanged();
				};
				this.hashChanged();
			},
			hashChanged: function() {
				var hash = location.hash;
				var postFilter = '';
				var categoryFilter = '';
				if (hash.includes('category')) {
					var path = location.hash.split('#/category/');
					categoryFilter = path[1];
				} else if (hash.includes('post')) {
					var path = location.hash.split('#/post/');
					postFilter = path[1];
				}
				this.set('postFilter', postFilter);
				this.set('categoryFilter', categoryFilter);
			},
			filterPost: function(postFilter, categoryFilter) {
				return function(post) {
					if (categoryFilter) {
						return post.category == categoryFilter;
					}
					if (postFilter) {
						return post.id == postFilter;
					}
					return true;
				};
			},
			show: function(v) {
				if (v) {
					return 'show';
				}
				return 'hide';
			}
		});
	</script>
</dom-module>