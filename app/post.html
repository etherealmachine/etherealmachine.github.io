<dom-module id="app-post">
	<script src="../bower_components/firebase/firebase.js"></script>
  <link rel="import" href="markdown.html">
  <link rel="import" href="editpost.html">
	<style>
		.form-inline:not([hidden]) {
			display: inline;
		}
		input.form-control {
			width: 400px;
		}
	</style>
	<template>
			<div class="panel panel-default">
				<div class="panel-heading clearfix">
					<span>{{ title }}</span> -
					<span>{{ datefmt(date) }}</span>
				</div>
				<div class="panel-body">
					<app-markdown content="{{ content }}"></app-markdown>
					<div>
						<template is="dom-repeat" items="{{ toTagString(tags) }}">
							<span class="label label-default">{{ item }}</span>
						</template>
					</div>
					<div class$="{{ show(authed) }}">
						<a
								href="#editpost"
								data-toggle="collapse">edit</a>
						<div class="collapse" id="editpost">
							<app-editpost postid="{{ postid }}"></app-editpost>
						</div>
					</div>
				</div>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'app-post',
			properties: {
				postid: String
	    },
	    ready: function() {
	    	var self = this;
				this.authed = false;
				this.editCollapsed = true;
				this.fb = new Firebase(
					'https://etherealmachine.firebaseio.com/posts/' + this.postid);
				this.fb.onAuth(function(user) {
					self.set('authed', user != null && user.provider == 'password');
				});
				this.title = '';
				this.date = 0;
				this.content = '';
				this.tags = [];
				this.fb.on('value', function(snapshot) {
					var post = snapshot.val();
					self.set('title', post.title);
					self.set('date', post.date);
					self.set('content', post.content);
					self.set('tags', post.tags);
				});
	    },
	    toTagString: function(tagSet) {
				var tags = [];
				for (var tag in tagSet) {
					tags.push(tag);
				}
				return tags;
	    },
	    edit: function(e) {
	    	e.preventDefault();
	    	this.editCollapsed = !this.editCollapsed;
	    },
			show: function(authed) {
				if (!authed) {
					return 'hide';
				}
				return '';
			},
			datefmt: function(millis) {
				return new Date(millis).toLocaleString('en');
			}
		});
	</script>
</dom-module>