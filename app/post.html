<dom-module id="app-post">
	<script src="../bower_components/firebase/firebase.js"></script>
  <link rel="import" href="markdown.html">
  <link rel="import" href="editpost.html">
	<style>
		.form-inline:not([hidden]) {
			display: inline;
		}
		input.form-control {
			width: 400px;
		}
	</style>
	<template>
		<div class="panel panel-default">
			<div class="panel-heading clearfix">
				<h4>
					<a
						href$="{{ concat('/#/post/', slug) }}"
						on-click="nav">
						<span>{{ title }}</span>
					</a>
				</h4>
				<p>Posted <span>{{ datefmt(creation) }}</p>
			</div>
			<div class="panel-body">
				<app-markdown content="{{ content }}"></app-markdown>
				<div>
					<template is="dom-repeat" items="{{ toTagString(tags) }}">
						<span class="label label-default">{{ item }}</span>
					</template>
				</div>
				<div class$="{{ show(authed) }}">
					<a
							href$="{{ concat('#edit', postid) }}"
							data-toggle="collapse">edit</a>
					<div class="collapse" id$="{{ concat('edit', postid) }}">
						<app-editpost postid="{{ postid }}"></app-editpost>
					</div>
				</div>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: 'app-post',
			properties: {
				postid: {
					type: String,
					observer: 'init'
				}
	    },
	    ready: function() {
				this.authed = false;
				this.editCollapsed = true;
				this.init();
			},
			init: function() {
	    	var self = this;
				this.fb = new Firebase(
					'https://etherealmachine.firebaseio.com/posts/' + this.postid);
				this.fb.onAuth(function(user) {
					self.set('authed', user != null && user.provider == 'password');
				});
				this.title = '';
				this.date = 0;
				this.content = '';
				this.tags = [];
				this.category = '';
				this.creation = 0;
				this.last_edit = 0;
				self.prev = '';
				self.next = '';
				this.fb.on('value', function(snapshot) {
					var post = snapshot.val();
					self.set('title', post.title);
					self.set('slug', self.slugify(post.title));
					self.set('date', post.date);
					self.set('content', post.content);
					self.set('tags', post.tags);
					self.set('category', post.category);
					self.set('creation', post.creation);
					self.set('last_edit', post.last_edit);
				});
	    },
	    concat: function(pre, id) {
	    	return pre + id;
	    },
	    toTagString: function(tagSet) {
				var tags = [];
				for (var tag in tagSet) {
					tags.push(tag);
				}
				return tags;
	    },
	    edit: function(e) {
	    	e.preventDefault();
	    	this.editCollapsed = !this.editCollapsed;
	    },
			show: function(authed) {
				if (!authed) {
					return 'hide';
				}
				return '';
			},
			slugify: function(s) {
				return s.toLowerCase().replace(/ /g, '-').replace(/[^\w-]+/g,'');
			},
			datefmt: function(millis) {
				return moment(millis).calendar();
			},
			nav: function(e) {
				e.preventDefault();
				var href = e.target.href;
				if (href == undefined) {
					href = e.target.parentNode.href;
				}
				window.location.hash = href.split('#')[1];
				return false;
			}
		});
	</script>
</dom-module>